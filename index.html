<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Coding dojo NodeJs</title>

	<meta name="description" content="Coding dojo NodeJs">
	<meta name="author" content="Benjamin Einaudi">

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="reveal.js-2.5.0/css/reveal.min.css">
	<link rel="stylesheet" href="reveal.js-2.5.0/css/theme/orange.css" id="theme">
	<link type="text/css" rel="stylesheet" href="highlight/styles/default.css" />
	<link type="text/css" rel="stylesheet" href="highlight/styles/darkula.css" />



	<link type="text/css" rel="stylesheet" href="shCoreCustom.css" />



	<!-- If the query includes 'print-pdf', use the PDF print sheet -->
	<script>
		document.write('<link rel="stylesheet" href="css/print/' + (window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper') + '.css" type="text/css" media="print">');
	</script>

	<!--[if lt IE 9]>
		<script src="reveal.js-2.5.0/lib/js/html5shiv.js"></script>
		<![endif]-->
	<script src="reveal.js-2.5.0/lib/js/head.min.js"></script>
	<script src="reveal.js-2.5.0/js/reveal.min.js"></script>
	<script src="jquery.min.js"></script>


	<script type="text/javascript" src="highlight/highlight.pack.js"></script>
	<script type="text/javascript">
		window.onload = function () {
			//hljs.initHighlightingOnLoad();
			$('pre code').each(function (i, block) {
				hljs.highlightBlock(block);
			});
			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,
				width: 1572,

				theme: Reveal.getQueryHash().theme || 'orange', // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{
						src: 'reveal.js-2.5.0/lib/js/classList.js',
						condition: function () {
							return !document.body.classList;
						}
					},
					{
						src: 'reveal.js-2.5.0/plugin/markdown/marked.js',
						condition: function () {
							return !!document.querySelector('[data-markdown]');
						}
					},
					{
						src: 'reveal.js-2.5.0/plugin/markdown/markdown.js',
						condition: function () {
							return !!document.querySelector('[data-markdown]');
						}
					},
                    // { src: 'reveal.js-2.5.0/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{
						src: 'reveal.js-2.5.0/plugin/zoom-js/zoom.js',
						async: true,
						condition: function () {
							return !!document.body.classList;
						}
					},
					{
						src: 'reveal.js-2.5.0/plugin/notes/notes.js',
						async: true,
						condition: function () {
							return !!document.body.classList;
						}
					}
                ]
			});

		}
	</script>

</head>

<body>
	<div class="reveal">

		<!-- Any section element inside of this container is displayed as a slide -->
		<div class="slides">

			<section class="home">
				<h1>Node Js</h1>
				<h3>Coding Dojo - Node Js</h3>
				<small>Anim&eacute; par vous m&ecirc;me</small>
			</section>

			<section>
				<section>
					<h2>Node JS</h2>
					<div>
						<ul>
							<li>Nodejs est un serveur d'application qui h&eacute;berge des applications &eacute;crites en javascript. </li>
							<li>Il s'ex&eacute;cute sur un thread unique et les op&eacute;ration E/S sont non bloquantes</li>
							<li>Il vient avec npm (gestionnaire de paquets) qui se charge des d&eacute;pendances</li>
						</ul>
					</div>
				</section>
				<section>
					<h2>exemple d'une op&eacute;ration d'IO non bloquante</h2>
					<div>
						<pre>
                                <code>
//appel Ã  l'operation
someIoOperation(param1,param2, param3,
    function(err, result){
        if(err){
            //ici err est non null
            handleError(err);
        }else{
            handleResult(result);
        }
});
                                </code>
                            </pre>
					</div>
				</section>
			</section>


			<section>
				<section>
					<h2>
							Pr&eacute;requis
						</h2>
				</section>
				<section>
					<ul>
						<li>Installer <a href="http://nodejs.org/dist/v0.10.25/">nodejs 0.10.25 (iso kermit)</a>
						</li>
						<li>Pour eburo: Installer le <a href="http://recommendations.si.fr.intraorange/environnement-de-d-veloppement-web/#cntlm">proxy cntlm</a>
						</li>
						<li>Un &eacute;diteur javascript(Bracket avec extension extension beautify, IntelliJ Ultimate, Nodeeclipse...)</li>
						<li><a href="http://www.mongodb.org/downloads#previous">MongoDb 2.4</a>
						</li>
					</ul>
				</section>
			</section>


			<section>
				<section>
					<h2>
                            Init
						</h2>
				</section>
				<section>
					<h2>R&eacute;cup&eacute;ration du code (tag init)</h2>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b init</code></pre>
				</section>
				<section>
					<h2>Arborescence</h2>
					<ul>
						<li>package.json : descriptif de l'application</li>
						<li>node_modules: l&agrave; o&ugrave; seront install&eacute;es les librairies requises. Taper npm install &agrave; la racine du projet.</li>
					</ul>
				</section>
				<section>
					<h2>app.js: l'application express</h2>
					<p>Notion de handler</p>
					<pre>
                            <code>
function(req, res, next){
}
                            </code>
                        </pre>
					<pre>
                            <code>
var express = require('express');
var path = require('path');
var favicon = require('serve-favicon');
var html = require('./routes/html')



var app = express();

app.use(favicon(__dirname + '/public/images/favicon.ico'));
app.use(express.static(path.join(__dirname, 'public')));

app.use('/', html);

// catch 404 and forward to error handler
app.use(function(req, res, next) {
    console.log("not found");
    var err = new Error('Not Found');
    err.status = 404;
    next(err);
});

// error handlers

// development error handler
// will print stacktrace
if (app.get('env') === 'development') {
    console.log("enabling stacks");
    app.use(function(err, req, res, next) {
        console.error(err);
        res.status(err.status || 500);
        res.json({
            message: err.message,
            error: err
        });
    });
}
else{
    // production error handler
    // no stacktraces leaked to user
    app.use(function(err, req, res, next) {
        res.status(err.status || 500);
        res.render({
            message: err.message,
            error: {}
        });
    });

}


module.exports = app;
                            </code>
                        </pre>
				</section>
				<section>
					<h2>server.js</h2>
					<pre>
                            <code>
#!/bin/env node

var defaultDebugMode =   "app:*";
if(typeof process.env.DEBUG == "undefined"){
    console.log("Adding DEBUG variable to "+defaultDebugMode);
    process.env.DEBUG=defaultDebugMode;
}else{
    console.log("DEBUG already set to "+defaultDebugMode);
}

var http = require('http');
var path = require('path');
var debug = require('debug')('app:server');
var error = require('debug')('app:server');
var app = require("./app");

debug.log = console.log.bind(console);

var server = http.createServer( app);

var host = null;
var port = 8080;

debug("server will listen on %s:%d",
                    host == null? "*" : host, port);

server.listen(port, host, function () {
    var mDate = new Date(Date.now());
    debug('%s: Node server started on %s:%d ...',
                        mDate, host == null? "*" : host, port);
});

                            </code>
                        </pre>
				</section>
				<section>
					<h2>Ex&eacute;cution</h2>
					<ul>
						<li>D&eacute;marrage <pre><code>node server.js</code></pre>
						</li>
						<li>Aller sur: http://localhost:8080</li>
					</ul>
				</section>
				<section>
					<h2>Ouf!</h2>
				</section>

			</section>
			<section>
				<section>
					<h2>Jade</h2>
				</section>
				<section>
					<h3>Ajout d&eacute;pendance 1.9.2</h3>
					<ul>
						<li>D&eacute;claration</li>
						<li>Installation</li>
					</ul>
				</section>
				<section>
					<h3>D&eacute;claration Jade dans application</h3>
					<pre>
                            <code>
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'jade');
                            </code>
                        </pre>
				</section>
				<section>
					<h3>D&eacute;claration de la vue</h3>
					<pre>
                            <code>
doctype html
    html
        head
            title=title
        body
            h2 Hello
                small you
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Perdu?</h3>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b init_jade</code></pre>
				</section>
				<section>
					<h3>Exemples</h3>
					<pre>
                            <code>
doctype html
    html(lang="en")
    head
        title= pageTitle
        script(type='text/javascript').
            if (foo) {
                bar(1 + 5)
            }
    body
        h1 Jade - node template engine
        #container.col
        if youAreUsingJade
            p You are amazing
        else
            p Get on it!
            p.
                Jade is a terse and simple
                templating language with a
                strong focus on performance
                and powerful features.
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Exercice</h3>
					<p>R&eacute;&eacute;crire <i>hello.html</i> avec jade</p>
					<ul>
						<li>banners.jade: contient les banner warning et error et le javascript associ&eacute;</li>
						<li>header.jade: contient les banner warning et error et le javascript associ&eacute;</li>
						<li>layout.jade: contient le squelette de la page (utiliser blocks pour la notion de template)</li>
						<li>hello.jade: &eacute;tend layout.jade et d&eacute;finit le block content d&eacute;fini dans layout.jade</li>
					</ul>
				</section>
				<section>
					<h3>Perdu?</h3>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b exercice_jade</code></pre>
				</section>
			</section>
			<section>
				<section>
					<h2>MongoDb</h2>
				</section>
				<section>
					<h3>Ajout d&eacute;pendance 0.18.0</h3>
					<ul>
						<li>D&eacute;claration</li>
						<li>Installation (soit par npm install, soit d&eacute;compression de mongojs.zip dans node_modules</li>
						<li>D&eacute;marrage mongo sur port 27017 (d&eacute;faut)<pre><code>mongod --dbpath db.data/ --port 27017</code></pre>
						</li>
					</ul>
				</section>
				<section>
					Ouverture de l'objet base de donn&eacute;e mongo
					<h3>Dans un fichier dao/db.js</h3>
					<pre>
                            <code>
var mongojs = require('mongojs');
var debug= require('debug')('app:db');
debug.log = console.log.bind(console);

var dbHost = 'localhost';
var dbPort = 27017;
var dbName = 'CodingDojoNodeJs';


var db = mongojs(dbHost+':'+dbPort+'/'+dbName);

debug('db loaded');
module.exports =  {
    developer : db.collection('developer')
} ;

                            </code>
                        </pre>
				</section>
				<section>
					<h3>Une dao</h3>
					<p>Dans dao/developer.js</p>
					<pre>
                            <code>
var debug= require('debug')('app:dao:db');
debug.log = console.log.bind(console);


exports = module.exports = buildDeveloperDao;


function buildDeveloperDao(collection){

    function convertDeveloperFrom(obj){
        obj.name = obj._id;
        delete obj._id;
        return obj;
    }

    function list(callback){
        collection.find().map(convertDeveloperFrom, callback);
    }

    function get(name, callback){
        collection.findOne({
            _id: name
            },function(err, developer){
                if(err)
                    callback(err,null);
                else if(developer == null){
                    var notFoundError = Error();
                    notFoundError.status = 404;
                    notFoundError.message = "Not Found";
                    callback(notFoundError, null);
                }else
                    callback(null, convertDeveloperFrom(developer));
        });
    }

    function create(name, param1, param2, callback){
        /*
        collection.save({_id : name, field1: field1, param1: param2 }, callback);
        */
    }

    function update(name, param1, param2, callback) {
        //collection.update({_id: name}, {$set: {field1: param1, field2: param2}}, callback);
    }

    function remove(name, callback){
        collection.remove({
            _id: name
        },true, callback);
    }

    return{
        list : list,
        get : get,
        create : create,
        update : update,
        remove : remove
    };

}
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Un index pour faciliter l'acc&egrave;s &agrave; la DAO</h3>
					<p>Dans dao/index.js</p>
					<pre>
                            <code>
var db = require("./db");
exports = module.exports = {developers : require("./developer")(db.developer)};
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Un service rest</h3>
					<p>Dans rest/developer.js</p>
					<pre>
                            <code>
var express = require('express');
var debug= require('debug')('app:rest:developer');
var error= require('debug')('app:rest:developer');

debug.log = console.log.bind(console);


exports = module.exports = loadDevelopersRouter;




function loadDevelopersRouter(dao){
    var router = express.Router();



    router.param('developer_name', function(req, res, next, name) {
        req.developerName = name;
        next();
    });



    router.route('/').get(function(req, res, next){
        dao.list(function(err, developers) {
            if(err != null){
                error('developers -get -  error %s', err);
                next(err);
            }else{
                debug('developers - get -  found %d', developers.length);
                res.json(developers);
            }
        });

    }).post(function(req, res, next){
        //call dao.create
        var error = Error();
        error.status = 501;
        error.message = "Not Implemented";
        next(err);
    });

    router.route('/:developer_name/').get(function(req, res, next) {
        var developerName = req.developerName;
        dao.get(developerName
                , function (err, developer) {
                    if(err != null){
                        error('developer - get - error %s', err);
                        next(err);
                    }else{
                        debug('developer - get - %s - found', developerName);
                        res.json(developer);
                    }
                });
    }).put(function(req, res, next) {
        //call dao.update
        var error = Error();
        error.status = 501;
        error.message = "Not Implemented";
        next(err);

    }).delete(function(req, res, next){
        //call dao.remove
        var error = Error();
        error.status = 501;
        error.message = "Not Implemented";
        next(err);
    });


    debug('developers loaded');
    return router;

}
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Routing in app</h3>
					<pre>
                            <code>
var daos = require("./dao");

var developer = require("./routes/rest/developer");
//...
app.use('/services/developers/', developer(daos.developers));
                            </code>
                        </pre>
				</section>
				<section>
					<h3>Perdu?</h3>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b template_rest</code></pre>
				</section>
				<section>
					<h3>Exercice</h3>
					<p>Impl&eacute;menter GET/POST/PUT/DELETE et une page d&eacute;di&eacute;e</p>
				</section>
			</section>
			<section>
				<section>
					<h2>Tests</h2>
				</section>

				<section>
					<h3>Ce dont nous avons besoin pour commencer</h3>
					<ul>
						<li>Un framework de test: Mocha 2.2.5</li>
						<li>Une librairie d'assertion:
							<ul>
								<li>assert: native en node js, minimaliste</li>
								<li>chai: librairie d'assertion TDD/BDD</li>
								<li>should: librairie d'assertion BDD</li>
							</ul>
						</li>
					</ul>

				</section>
				<section>
					<h3>Code</h3>
					<label>R&eacute;cup&eacute;rer le code qui impl&eacute;mente les GET/POST/PUT/DELETE sur les developpers ainsi qu'une page jade</label>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b init_test</code></pre>
					<p>Installer les deux librairies</p>
					<pre><code>npm install</code></pre>
				</section>
				<section>
					<h3>Lancement des tests</h3>
					<pre><code>node_modules/mocha/bin/mocha</code></pre>
				</section>
				<section>
					<h3>Test Dao</h3>
					<p>Pr&eacute;requis</p>
					<ul>
						<li>Ajouter la librairie mockery 1.4.0: permet de contr&ocirc;ler les chargements des d&eacute;pendances</li>
						<li>R&eacute;cu&ecirc;p&eacute;rer le code
							<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b init_test_dao</code></pre>
						</li>
					</ul>
					<p>Coder les tests sur le get/create/remove (penser &agrave; lancer mongo)</p>
					<p>remplacer should.be.true par should.be.true()</p>
					<p>* Trouver l'erreur dans dao.create* </p>
				</section>
				<section>
					<h3>Test Rest</h3>
					<p>Pr&eacute;requis</p>
					<ul>
						<li>Ajouter la librairie npm install supertest 1.0.1: client l&eacute;ger http</li>
						<li>R&eacute;cup&eacute;rer le code
							<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b init_test_rest</code></pre>
						</li>
					</ul>
					<p>Coder les tests sur le GET/POST/PUT/DELETE (penser &agrave; lancer mongo)</p>
					<p>* Trouver l'erreur dans POST cr&eacute;ation de ressource existante, ainsi que le probl&egrave;me de gestion du champs agile dans les formulaires url encoded *</p>
				</section>
				<section>
					<h3>Perdu?</h3>
					<pre><code>git clone  https://github.com/antechrestos/CodingDojoNodeJs.git -b end_test_rest</code></pre>
				</section>
				<section>
					<h3>Pour aller plus loin</h3>
					<p>Test avec Mocha et selenium...</p>
				</section>
			</section>
			<section>
				<h2>Merci &agrave; vous</h2>
			</section>
		</div>
	</div>

</body>

</html>
